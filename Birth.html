<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/main.css">
    <script src="js/main.js" type="module"></script>
    <script type="module" src="js/deer/js/deer.js"></script>
    <script src="js/layout.js"></script>
    <script src="js/shared.js"></script>
    <title>Birth Event - Musical Maps of the World</title>
</head>

<body is="mm-content">
    <div class="container" slot="content">

        <deer-a class="btn btn-secondary" deer-link="person.html#" hash-id>Profile </deer-a>

        <h3>
            Describe the Birth
        </h3>
        <p>
            Use this form to add a new event to the musical maps.
            A proper event has an impact on a person or location within
            this project and has both a time and place. Evidence for these
            assertions should be included with every entry.
        </p>
        <p class="text-info">
            NB: As a sandbox prototype, all annotations will be created with
            the same authentication and is subject to revision.
        </p>
        <form deer-type="Birth" deer-context="http://schema.org" deer-creator="mm-prototype" id="DOB">
            <input deer-key="creator" value="mm-prototype" type="hidden">

            <div class="row">
                <div class="form-group col-md-6">
                    <label for="name">Name</label>
                    <input type="text" name="name" deer-key="name" class="form-control"
                        placeholder="Enter a label for this Event">
                </div>
                <div class="form-group col-md-6">
                    <label for="location">Event location</label>
                    <input id="geoNameInput" type="url" class="form-control" deer-key="location" name="location"
                        required>
                    <a id="geoNameLink" target="_blank" title="Open search in a new tab">Search GeoNames</a>
                    <small class="form-text text-muted">GeoNames URI:
                        "https://www.geonames.org/#######/CITY.html"</small>
                </div>
            </div>

            <div class="row">
                <div class="form-group col-md-6">
                    <label for="date">Exact date</label>
                    <input type="date" class="form-control" deer-key="date" name="date" min="1700-01-01"
                        max="2050-12-31" required>
                </div>
            </div>

            <button id="birthBtn" type="submit" class="btn btn-primary">Create Birth ðŸŽ‚</button>
        </form>

        <form class="is-hidden" deer-type="Person" hash-id id="person" deer-creator="mm-prototype">
            <input deer-key="creator" value="mm-prototype" type="hidden">
            <div class="row">
                <div class="form-group col">
                    <label for="presentAt">Present At</label>
                    <input type="text" class="form-control" deer-key="presentAt" name="presentAt">
                </div>
            </div>
            <div class="row">
                <div class="form-group col-md-6">
                    <label for="birthDate">Birth Date</label>
                    <input type="date" class="form-control" deer-key="birthDate" name="birthDate">
                </div>
                <div class="form-group col-md-6">
                    <label for="birthPlace">Birth Place</label>
                    <input type="url" class="form-control" deer-key="birthPlace" name="birthPlace">
                </div>
            </div>
            <button type="submit" id="personSubmit" class="btn btn-primary">Update Person</button>
        </form>
    </div>
    <script>
        let existingBirthEvent = ""
//For when we need to fire input events programmatically.
        let inputEvent = new Event('input', {
            bubbles: false,
            cancelable: true
        })

        // https://www.geonames.org/search.html?q=CITY&country=COUNTRY
        geoNameInput.addEventListener('input', ev => {
            const queryLocation = ev.target.value?.split(',')
            const city = queryLocation[0].trim()
            if (city.includes("geonames.org")) {
                geoNameLink.classList.remove('btn', 'btn-secondary')
                geoNameLink.classList.add('is-hidden')
                return
            }
            const country = queryLocation?.[1] ? `&country=${queryLocation?.[1]?.trim()}` : ``
            const query = `https://www.geonames.org/search.html?q=${city}${country}`
            geoNameLink.setAttribute("href", query)
            geoNameLink.textContent = `Search for ${city}`
            geoNameLink.classList.add('btn', 'btn-secondary')
            geoNameLink.classList.remove('is-hidden')
        })

        ;(() => {
            let hash = location.hash?.substring(1)
            if (!hash) { return }
            const rerumPrefix = "https://devstore.rerum.io/v1/id/"
            if (hash.length === 24) { hash = `${rerumPrefix}${hash}` }
            fetch(hash).then(res => res.json()).then(p => {
                if (p['@type'] !== "Person") { alert("This Event expects a Person but got a " + p['@type']) }
                const nameInput = document.querySelector('[name="name"]')
                if (!nameInput || nameInput?.value?.length > 2) { return }
                nameInput.setAttribute('value', `Birth of ${p.name || "ERR!"}`)
            })
            fetch("https://tinydev.rerum.io/app/query?limit=50&skip=0", {
                method: "POST",
                mode: "cors",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    target: hash,
                    'body.presentAt': { $exists: true },
                    'creator' : 'mm-prototype',
                    "__rerum.history.next":{ $exists: true, $eq: [] }
                })
            }).then(response => response.json())
            .then(eventSet => Promise.all(eventSet[0].body.presentAt.items.map(uri=>fetch(uri).then(response => response.json()))))
                .then(events => {
                    const eventMatch = events.filter(ev=> {
                        const t = ev["@type"] ?? ev.type ?? ""
                        return t === "Birth"
                    })
                    if (eventMatch.length > 0) {
                        alert("Existing Birth event found.")
                        // What should we do if more than one Birth event is recorded?
                        birthBtn.innerText = "Update Birth Event"
                        const birthEventURI = eventMatch.pop()?.['@id']
                        DOD.setAttribute("deer-id", birthEventURI)
                        existingBirthEvent = birthEventURI
                    }
                })
        })()

        document.addEventListener('deer-updated', ev => {
            // fire only when new event is created
            const newEvent = ev.detail
            const t = newEvent["@type"] ?? newEvent.type ?? ""
            if (t !== "Birth") { return } // not the right form

            let events_tracked = person.querySelector('[name="presentAt"]').value
            let event_delim = person.querySelector('[name="presentAt"]').hasAttribute("deer-array-delimeter") ? person.querySelector('[name="presentAt"]').getAttribute("deer-array-delimeter") : ","
            if(events_tracked){
                if(events_tracked.includes(existingBirthEvent)){
                    events_tracked = events_tracked.replace(existingBirthEvent, newEvent['@id'])
                }
                else{
                    events_tracked += `${event_delim}${newEvent['@id']}`    
                }
            }
            else{
                events_tracked = newEvent['@id']
                existingBirthEvent = newEvent['@id']
            }
            person.querySelector('[name="presentAt"]').value = events_tracked
            person.querySelector('[name="presentAt"]').dispatchEvent(inputEvent)
            person.querySelector('[name="birthDate"]').value = document.querySelector('[name="date"]').value
            person.querySelector('[name="birthDate"]').dispatchEvent(inputEvent)
            person.querySelector('[name="birthPlace"]').value = geoNameInput.value
            person.querySelector('[name="birthPlace"]').dispatchEvent(inputEvent)
            person.$isDirty = true
            personSubmit.click()
        })

        /**
         * Detects that all annotation data is gathered and all HTML of the form is in the DOM and can be interacted with.
         * This is important for pre-filling or pre-selecting values of multi select areas, dropdown, checkboxes, etc. 
         * This event will come after all deer-view-rendered events have finished.
         * @see deer-record.js DeerReport.constructor()  
         */
        addEventListener('deer-form-rendered', event => {
            const expandedEntity = event.detail
            const t = expandedEntity["@type"] ?? expandedEntity.type ?? ""
            if (t !== "Person") { return } // not the right form
            setTrackedHiddenValues(expandedEntity, ["presentAt"], event.target)
        })

    </script>
</body>

</html>
