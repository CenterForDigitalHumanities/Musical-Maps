<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/main.css">
    <script src="js/main.js" type="module"></script>
    <script src="js/layout.js"></script>
    <title>Enter a Person - Musical Maps of the World</title>
</head>

<body is="mm-content">
    <div class="container" slot="content">
        <h3>
            Describe the Person
        </h3>
        <p>
            Use this form to add a new person to the musical maps.
            A proper person has an impact on music and occupies an authority file entry.
            Evidence for these
            assertions should be included with every entry.
        </p>
        <p class="text-info">
            NB: As a sandbox prototype, all annotations will be created with
            the same authentication and is subject to revision.
        </p>
        <form deer-type="Person" deer-context="http://schema.org" hash-id>
            <input deer-key="creator" value="mm-prototype" type="hidden">
            <input deer-key="targetCollection" value="Musical Map People" type="hidden">

            <div class="row">
                <div class="form-group col-md-6">
                    <label for="name">Name</label>
                    <input type="text" id="mmLabel" name="name" deer-key="name" class="form-control"
                        placeholder="Enter a label/displayname for this Person">
                    <small class="form-text text-muted">This name is for internal display</small>
                </div>

                <div class="form-group col-md-6">
                    <label for="auth-record">LOC Name Record</label>
                    <input type="url" class="form-control" deer-key="uri" name="auth-record" id="authorityFile"
                        placeholder="https://id.loc.gov/authorities/names/n########">
                    <small class="form-text text-muted">URI from <a id="locLink" target="_blank"
                            href="https://id.loc.gov/authorities/names.html">LOC Name Authority</a>
                    </small>
                </div>
            </div>
            <div class="row" id="authorityDetails">
            </div>
            <div class="row">
                <div class="form-group col-md-6">

                </div>

                <div class="form-group col-md-6">

                </div>
            </div>

            <div class="row">
                <div class="form-group col-md-6">
                    <label for="occupation">Primary Occupation</label>
                    <select name="occupation" multiple id="occupation" class="form-control" deer-key="occupation">
                        <option value="~composer">composer</option>
                        <option value="~arranger">arranger</option>
                        <option value="~performer">performer</option>
                        <option value="~instrumentalist">instrumentalist</option>
                        <option value="~vocalist">vocalist</option>
                        <option value="~conductor">conductor</option>
                        <option value="~performance ensemble">performance ensemble</option>
                        <option value="~theorist">theorist</option>
                        <option value="~historian">historian</option>
                        <option value="~pedagogue">pedagogue</option>
                        <option value="~musical collaborator">musical collaborator</option>
                        <option value="~instrument maker">instrument maker</option>
                    </select>
                    <small class="form-text text-muted">Hold <kbd>CTRL</kbd> to select several options</small>
                </div>
                <div class="form-group col-md-6">
                    <label for="additionalOccupation">Secondary Occupation</label>
                    <select name="additionalOccupation" multiple id="additionalOccupation" class="form-control"
                        deer-key="additionalOccupation">
                        <option value="~composer">composer</option>
                        <option value="~arranger">arranger</option>
                        <option value="~performer">performer</option>
                        <option value="~instrumentalist">instrumentalist</option>
                        <option value="~vocalist">vocalist</option>
                        <option value="~conductor">conductor</option>
                        <option value="~performance ensemble">performance ensemble</option>
                        <option value="~theorist">theorist</option>
                        <option value="~historian">historian</option>
                        <option value="~pedagogue">pedagogue</option>
                        <option value="~musical collaborator">musical collaborator</option>
                        <option value="~instrument maker">instrument maker</option>
                    </select>
                    <small class="form-text text-muted">Hold <kbd>CTRL</kbd> to select several options</small>
                </div>
            </div>
            <div class="row d-none">
                <div class="form-group col-md-6">
                    <label for="vocalRange">Vocal Range</label>
                    <select name="vocalRange" multiple id="vocalRange" class="form-control" deer-key="vocalRange">
                        <option value="~bass">bass</option>
                        <option value="~baritone">baritone</option>
                        <option value="~tenor">tenor</option>
                        <option value="~alto">alto</option>
                        <option value="~mezzo-soprano">mezzo-soprano</option>
                        <option value="~soprano">soprano</option>
                    </select>
                </div>
                <div class="form-group col-md-6">
                    <p>// TODO: musical collaborator types</p>
                    <p>// TODO: instruments</p>
                    <p>// TODO: other ensemble members</p>
                </div>
            </div>

            <button type="submit" class="btn btn-primary">Create Person üë§</button>
        </form>

        <script type="module" src="js/deer/js/deer.js"></script>

        <h4>Life Events</h4>
        <div class="row">
            <div class="col">
                <deer-map-link hash-id deer-link="entitymap.html?data="> View on a map üåç</deer-map-link>
            </div>
        </div>
        <div class="row">
            <div class="form-group col">
                <deer-a class="btn btn-secondary col" deer-link="Birth.html#" hash-id id="birthBtn">
                    Birth
                    <deer-view deer-key="birthDate" deer-title=" date" deer-template="prop" hash-id>Birth</deer-view>
                </deer-a>
            </div>
            <div class="form-group col">
                <deer-a class="btn btn-secondary col" deer-link="Death.html#" hash-id id="deathBtn">
                    Death
                    <deer-view deer-key="deathDate" deer-title=" date" deer-template="prop" hash-id>Death</deer-view>
                </deer-a>
            </div>
            <div class="form-group col">
                <deer-a class="btn btn-secondary col" deer-link="Performance.html#" hash-id id="performanceBtn">
                    Performances
                </deer-a>
            </div>
            <div class="form-group col">
                <deer-a class="btn btn-secondary col" deer-link="Appearance.html#" hash-id id="appearanceBtn">
                    Appearances
                </deer-a>
            </div>
        </div>
        <div class="d-none">
            <h4>Residencies</h4>
            <div class="row">
                <div class="form-group col">
                    <button class="btn btn-secondary col" disabled="disabled">Lived at</button>
                </div>
                <div class="form-group col">
                    <button class="btn btn-secondary col" disabled="disabled">Studied at</button>
                </div>
                <div class="form-group col">
                    <button class="btn btn-secondary col" disabled="disabled">Worked at</button>
                </div>
            </div>
            <div class="row">
                <div class="form-group col-md-4">
                    <h4>Students</h4>
                    <button class="btn btn-secondary col" disabled="disabled">Add a student</button>
                </div>
                <div class="form-group col-md-4">
                    <h4>Teachers</h4>
                    <button class="btn btn-secondary col" disabled="disabled">Add a teacher/pedagogue</button>
                </div>
            </div>

        </div>
    </div>
    <script>
        addEventListener('deer-form-rendered', ev => locLink.setAttribute('href', `https://id.loc.gov/search/?q=${mmLabel.value.trim().replace(/\s/g, "+")}&q=cs:http://id.loc.gov/authorities/names`))
        authorityFile.addEventListener('click', async ev => {
            // https://id.loc.gov/authorities/names/n79011997.json
            const locId = authorityFile.value?.split('/').pop()
            if (locId.length !== 9) { return }
            const jsonURI = `https://id.loc.gov/authorities/names/${locId}.json`
            const nameFile = await fetch(jsonURI).then(res => res.json()).catch(err => { })
            const ObjectMap = new Map()
            nameFile.forEach(element => {
                const type = Array.isArray(element['@type']) ? element['@type'].pop() : element['@type']
                const key = type.split('/').pop()
                const keyForVal = Object.keys(element).find(k => k.startsWith('http'))
                const currentVal = ObjectMap.get(key)
                const newVal = Array.isArray(currentVal) ? currentVal.push(element[keyForVal].pop?.()?.['@value']) : [element[keyForVal].pop?.()?.['@value']]
                ObjectMap.set(key, newVal)
            })
            authorityDetails.innerHTML = `
            <dl>
                ${[...ObjectMap.keys()].reduce((a, b) => {
                return a += `<dt>${b}</dt>
                    <dd>${ObjectMap.get(b)}</dd>`
            }, ``)}
            </dl>
            `
        })
    </script>
</body>

</html>
